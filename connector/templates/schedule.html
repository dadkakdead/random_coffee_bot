{% extends 'base.html' %}

{% block customstatic %}
<script>
    console.log({{meetings_obj}});

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start,c_end));
            }
        }
        return "";
    }

    function request_to_shuffle_meetings(year, week) {
        fetch("/api/shuffle_meetings", {
          method: "POST",
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "X-CSRFToken": getCookie("csrftoken"),
            "Credentials": "same-origin"
          },
          body: JSON.stringify({"year": year, "week": week, "ignore_time_flow": true})
        }).then(resStream => {
            if (resStream.status == 200) {
                return resStream.json();
            } else {
                throw new Error();
            }
        }).then(res => {
            if (Object.keys(res).includes("meetings")) {
                message = `–£–¥–∞–ª–æ—Å—å —Å–æ—Å—Ç–∞–≤–∏—Ç—å ${res.meetings.length} –≤—Å—Ç—Ä–µ—á.\n\n` +
                `–ü—Ä–∏–Ω—è–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ: ${Object.keys(res.profiles).length}\n` +
                `–ï—Å—Ç—å, –∫–æ–≥–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å: ${res.has_more_people_to_meet}`;
                console.log(res);
                alert(message);
                location.reload();
            } else {
                message = `–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–∏ –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é.`;
                alert(message);
            }
        }).catch(err => {
            alert('–°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞. –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.')
            console.log(err);
        });
    }

    function connect_participants(year, week) {
	alert("–ë—É–¥—å –≥–æ—Ç–æ–≤ –∫ —Ç–æ–º—É, —á—Ç–æ —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞. –ü—Ä–∏–¥–µ—Ç—Å—è –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å.");

        fetch("/api/connect_participants", {
          method: "POST",
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "X-CSRFToken": getCookie("csrftoken"),
            "Credentials": "same-origin"
          },
          body: JSON.stringify({"year": year, "week": week})
        }).then(resStream => {
            if (resStream.status == 200) {
                return resStream.json();
            } else {
                throw new Error();
            }
        }).then(res => {
            message = `–†–∞—Å—Å—ã–ª–∫–∞ —Å–¥–µ–ª–∞–Ω–∞.`;
            alert(message);
            location.reload();
        }).catch(err => {
            alert('–°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞. –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.')
            console.log(err);
        });
    }

    function resend_invitation(user_id, year, week) {
        fetch("/api/resend_invitation", {
          method: "POST",
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "X-CSRFToken": getCookie("csrftoken"),
            "Credentials": "same-origin"
          },
          body: JSON.stringify({"user_telegram_id": user_id, "year": year, "week": week})
        }).then(resStream => {
            if (resStream.status == 200) {
                return resStream.json();
            } else {
                throw new Error();
            }
        }).then(res => {
            message = `–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.`;
            alert(message);
            location.reload();
        }).catch(err => {
            alert('–°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞. –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.')
            console.log(err);
        });
    }

    function collect_feedback(user_1_telegram_id, user_2_telegram_id, year, week) {
        fetch("/api/collect_feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "X-CSRFToken": getCookie("csrftoken"),
            "Credentials": "same-origin"
          },
          body: JSON.stringify({"user_1_telegram_id": user_1_telegram_id, "user_2_telegram_id": user_2_telegram_id, "year": year, "week": week})
        }).then(resStream => {
            if (resStream.status == 200) {
                return resStream.json();
            } else {
                throw new Error();
            }
        }).then(res => {
            message = `–ó–∞–ø—Ä–æ—Å –Ω–∞ —Ñ–∏–¥–±–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.`;
            alert(message);
            location.reload();
        }).catch(err => {
            alert('–°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞. –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.')
            console.log(err);
        });
    }
</script>
{% endblock %}

{% block title %}Random Coffee{% endblock %}

{% block content %}


    <div style="">
        <div style="font-size:24pt"> Random Coffee START HUB</div>
        <div style="">
            <b>–ù–µ–¥–µ–ª—è {{timestamps.now.week}}, {{ timestamps.now.day_from|date:'d.m.y' }} - {{ timestamps.now.day_to|date:'d.m.y' }}</b>

            &nbsp&nbsp&nbsp

            <a href="/schedule?week={{timestamps.week_ago.week}}&year={{timestamps.week_ago.year}}">
                <--
            </a>

            &nbsp&nbsp|&nbsp&nbsp

            <a href="/schedule?week={{timestamps.week_after.week}}&year={{timestamps.week_after.year}}">
                -->
            </a>
        </div>
    </div>

    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

    <div style='font-size:8pt'>
        <table>
            <tr>
                <td style='border: 0.5px solid grey; padding: 5px 10px;'>
                    <b>–ü–æ–ª</b>
                    <il>
                        <li>–ú–∞–ª—å—á–∏–∫–∏: {{statistics.gender.male}}</li>
                        <li>–î–µ–≤–æ—á–∫–∏: {{statistics.gender.female}} </li>
                    </il>
                </td>
                <td style='border: 1px solid grey; padding: 5px 10px;'>
                    <b>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</b>
                    <il>
                        <li>2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é: {{statistics.frequency.high}}</li>
                        <li>1 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é: {{statistics.frequency.medium}}</li>
                        <li>1 —Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏: {{statistics.frequency.low}}</li>
                    </il>
                </td>
                <td style='border: 1px solid grey; padding: 5px 10px;'>
                    <b>–ú–æ—Ç–∏–≤–∞—Ü–∏—è</b>
                    <il>
                        <li>–ù–∞–π—Ç–∏ –≤—Ç–æ—Ä—É—é –ø–æ–ª–æ–≤–∏–Ω—É: {{statistics.motivation.dating}}</li>
                        <li>–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ —Ä–∞–±–æ—Ç–µ: {{statistics.motivation.networking}}</li>
                        <li>–ü—Ä–æ—Å—Ç–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å: {{statistics.motivation.fun}}</li>
                    </il>
                </td>
            </tr>
        </table>
    </div>

    <h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>

    {% for category_name, users_list in users.items %}
        {% if users_list|length > 0 %}
            {% if category_name == "accepted" %}<b style="color: green"> –ü—Ä–∏–Ω—è–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ </b>{% endif %}
            {% if category_name == "thinking" %}<b style="color: orange"> –î—É–º–∞—é—Ç –Ω–∞–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º </b>{% endif %}
            {% if category_name == "declined" %}<b style="color: red"> –û—Ç–∫–ª–æ–Ω–∏–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ </b>{% endif %}
            {% if category_name == "awaiting_invitation" %}–ù–µ –ø–æ–ª—É—á–∏–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ {% endif %}
            {% if category_name == "awaiting_registration" %}–ù–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é {% endif %}
            {% if category_name == "disabled" %}–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {% endif %}
            {% if category_name == "undefined" %}–í –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ {% endif %}
            ({{users_list|length}} / {{total_users}})

            <table>
                <tr>
                    <td>
                        <ul>
                        {% for u in users_list %}
                            <li>{{u.1}}{% if u.2 != ''%}, {{u.2}}{% endif %} ({{u.3}}) &nbsp&nbsp
                                {% if category_name != "awaiting_registration" and category_name != "undefined" and category_name != "disabled" %}
                                    <button onclick="resend_invitation({{u.0}}, {{timestamps.now.year}}, {{timestamps.now.week}})">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–Ω–æ–≤–∞</button>
                                 {% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
            </table>
        {% endif %}
    {% endfor %}


    <h2>–í—Å—Ç—Ä–µ—á–∏</h2>

    {% if meetings|length == 0%}
        <ul>
            –í—Å—Ç—Ä–µ—á–∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
        </ul>
        <button onclick="request_to_shuffle_meetings({{timestamps.now.year}}, {{timestamps.now.week}})">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
    {% else %}
        <ul>
        {% for m in meetings %}
            <li>
                {{m.0.1}}{% if m.0.2 != ''%}, {{m.0.2}} {% endif %} ‚Äî {{m.1.1}}{% if m.1.2 != ''%}, {{m.1.2}} {% endif %} <b>|</b>
                {% if m.2 %}
                    –í—Å—Ç—Ä–µ—á–∞ –ø—Ä–æ—à–ª–∞  {% if m.3 %} üòÑ {% else %} üòî {% endif%}
                {% else %}
                    –í—Å—Ç—Ä–µ—á–∏ –Ω–µ –±—ã–ª–æ
                {% endif%}
                {% if meeting_details_broadcasted %}
                    <button onclick="collect_feedback({{m.0.0}}, {{m.1.0}}, {{timestamps.now.year}}, {{timestamps.now.week}})">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–∏–¥–±–µ–∫</button>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
        {% if not meeting_details_broadcasted %}
            <button onclick="request_to_shuffle_meetings({{timestamps.now.year}}, {{timestamps.now.week}})">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
        {% endif %}
    {% endif %}
    <br><br>
    {% if meetings|length > 0%}
        {% if not meeting_details_broadcasted %}
            <button style="background-color: #f44336; color:white" onclick="connect_participants({{timestamps.now.year}}, {{timestamps.now.week}})">–†–∞–∑–æ—Å–ª–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å—Ç—Ä–µ—á–∞—Ö</button>
            –ö–Ω–æ–ø–∫—É –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å –≤—Å–µ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑.
        {% endif %}
    {% endif %}

{% endblock %}
